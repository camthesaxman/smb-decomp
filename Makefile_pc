GLEW_ZIP     := glew-2.2.0-win32.zip
GLEW_URL     := https://github.com/nigels-com/glew/releases/download/glew-2.2.0/glew-2.2.0-win32.zip
GLEW_LIB     := glew-2.2.0/lib/Release/Win32/glew32s.lib
GLEW_INC_DIR := glew-2.2.0/include

ifeq ($(TARGET_WINDOWS),1)
  CC := i686-w64-mingw32-gcc -m32
  CFLAGS := -O0 -g -Wall -Wextra -Wno-unknown-pragmas -Wno-unused-variable -Wno-unused-parameter
  CPPFLAGS := -idirafter include -idirafter $(GLEW_INC_DIR) -DNONMATCHING -DC_ONLY -DTARGET_PC
  LDFLAGS := -mwindows $(GLEW_LIB) -lopengl32 -ldinput8 -ldxguid --disable-shared -static -static-libstdc++ -lstdc++
  EXE := .exe
else
  CC := gcc -m32
  CFLAGS := -O0 -g -fsanitize=address -Wall -Wextra -Wno-unknown-pragmas -Wno-unused-variable -Wno-unused-parameter
  CPPFLAGS := -idirafter include -DNONMATCHING -DC_ONLY -DTARGET_PC $(shell pkg-config --cflags libevdev)
  LDFLAGS := -lm -lGL -lglfw $(shell pkg-config --libs libevdev) -fsanitize=address -lstdc++
  EXE :=
endif
CXXFLAGS := -std=c++20 -fno-exceptions

TARGET := supermonkeyball$(EXE)

SOURCES := \
	stubs.c \
	src/main.c \
	src/init.c \
	src/init_2.c \
	src/mathutil.c \
	src/mode.c \
	src/pause_menu.c \
	src/event.c \
	src/polydisp.c \
	src/adv.c \
	src/code_5.c \
	src/sel.c \
	src/game.c \
	src/camera.c \
	src/frustum.c \
	src/light.c \
	src/gxsync.c \
	src/info.c \
	src/code_7.c \
	src/input.c \
	src/bitmap.c \
	src/bmp_list_com.c \
	src/bmp_list_adv.c \
	src/bmp_list_end.c \
	src/bmp_list_rnk.c \
	src/bmp_list_sel.c \
	src/bmp_list_nml.c \
	src/bmp_list_bwl.c \
	src/bmp_list_rac.c \
	src/bmp_list_bil.c \
	src/bmp_list_fgt.c \
	src/bmp_list_glf.c \
	src/bmp_list_tgt.c \
	src/bmp_list_how.c \
	src/bmp_list_cmd.c \
	src/trig_tables.c \
	src/perf.c \
	src/pool.c \
	src/nl2ngc.c \
	src/motload.c \
	src/mot_joint.c \
	src/motload_3.c \
	src/motload_4.c \
	src/ball.c \
	src/mathutil_vec_cross_prod.c \
	src/stcoli.c \
	src/world.c \
	src/interpolate_keyframes.c \
	src/stage.c \
	src/code_8.c \
	src/recplay.c \
	src/recplay_2.c \
	src/background.c \
	src/bg_old_cave.c \
	src/bg_old_night.c \
	src/bg_old_space.c \
	src/bg_old_sunset.c \
	src/bg_old_bonus.c \
	src/bg_old_sand.c \
	src/bg_old_storm.c \
	src/bg_jungle.c \
	src/bg_sand.c \
	src/bg_water.c \
	src/bg_space.c \
	src/bg_sunset.c \
	src/bg_bonus.c \
	src/bg_storm.c \
	src/bg_end.c \
	src/course.c \
	src/item.c \
	src/item_coin.c \
	src/item_pilot.c \
	src/obj_collision.c \
	src/stobj.c \
	src/stobj_goal.c \
	src/sprite.c \
	src/textbox.c \
	src/hud.c \
	src/ord_tbl.c \
	src/code_3.c \
	src/ranking_screen.c \
	src/mot_ape.c \
	src/code_2.c \
	src/lzs_decompress.c \
	src/avdisp.c \
	src/load.c \
	src/mouse.c \
	src/rend_efc.c \
	src/rend_efc_mirror.c \
	src/rend_efc_3.c \
	src/relocation.c \
	src/gxutil.c \
	src/gxcache.c \
	src/memcard.c \
	src/DEMOPuts.c \
	src/view.c \
	src/code_6.c \
	src/dvd.c \
	src/preview.c \
	src/byteswap.cpp \
	src/sel_stage_rel.c \
	src/sel_stage_rel_2.c \
	src/sel_stage_rel_3.c \
	libraries/dolphin_pc/OS.c \
	libraries/dolphin_pc/GX_gles2.c \
	libraries/dolphin_pc/dvd.c \
	libraries/dolphin_pc/vi_glfw.c \
	libraries/dolphin_pc/vi_wgl.c \
	libraries/dolphin_pc/pad_evdev.c \
	libraries/dolphin_pc/pad_dinput.c \
	libraries/dolphin_pc/ar.c \
	libraries/dolphin_pc/arq.c \
	libraries/os/OSAlloc.c \
	libraries/os/OSArena.c \
	libraries/os/OSAudioSystem.c \
	libraries/os/OSError.c \
	libraries/os/OSMutex.c \
	libraries/os/OSSync.c \
	libraries/mtx/mtx44.c \
	libraries/dvd/dvdqueue.c \
	libraries/dvd/fstload.c \
	libraries/demo/DEMOFont.c \
	libraries/dsp/dsp.c \
	libraries/dsp/dsp_debug.c \
	libraries/dsp/dsp_task.c \
	libraries/hio/hio.c \
	libraries/gx/GXStubs.c \
	libraries/gx/GXPerf.c \
	libraries/amcnotstub/amcnotstub.c
O_FILES := $(addsuffix .o,$(SOURCES))
ALL_O_FILES := $(O_FILES)

$(TARGET): $(ALL_O_FILES)
	$(CC) $^ $(LDFLAGS) -o $@

%.c.o: %.c
	$(CC) -c $(CFLAGS) $(CPPFLAGS) -o $@ $<

%.cpp.o: %.cpp
	$(CC) -c $(CFLAGS) $(CXXFLAGS) $(CPPFLAGS) -o $@ $<

ifeq ($(TARGET_WINDOWS),1)
  libraries/dolphin_pc/GX_gles2.c.o: $(GLEW_LIB)
  $(TARGET): $(GLEW_LIB)
endif

$(GLEW_LIB): $(GLEW_ZIP)
	unzip $< && touch $@

$(GLEW_ZIP):
	wget $(GLEW_URL) -O $@

clean:
	$(RM) $(TARGET)
	find . -name '*.o' -exec rm {} +
	find . -name '*.dep' -exec rm {} +
	find . -name '*.dump' -exec rm {} +
